name: macOS (unsigned R) CI

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  pull_request:

jobs:
  test-macos-unsigned:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download unsigned R binary
        run: |
          curl -LO https://mac.r-project.org/big-sur/last-success/R-4.5-branch-arm64.tar.xz
          sudo tar -xJf R-4.5-branch-arm64.tar.xz -C /
          echo "/Library/Frameworks/R.framework/Resources/bin" >> $GITHUB_PATH

      - name: Check R version
        run: R --version

      - name: Install dependencies
        run: |
          Rscript -e 'install.packages(c("devtools", "tinytest"), repos="https://cloud.r-project.org")'

      - name: Install package
        run: |
          R CMD build .
          PKG_TAR=$(ls -1t *.tar.gz | head -n1)
          R CMD INSTALL "$PKG_TAR"

      - name: Run tests
        run: |
          Rscript -e 'tinytest::test_package("Rtinycc")'
