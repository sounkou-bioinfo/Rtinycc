name: macOS (unsigned R) CI

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  pull_request:

jobs:
  test-macos-unsigned:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download unsigned R binary
        run: |
          curl -LO https://mac.r-project.org/big-sur/R-4.5-branch/arm64/R-4.5-branch.tar.gz
          sudo tar -xzf R-4.5-branch.tar.gz -C /
          echo "/Library/Frameworks/R.framework/Resources/bin" >> $GITHUB_PATH
          echo "R_HOME=/Library/Frameworks/R.framework/Resources" >> $GITHUB_ENV
      - name: Copy R libtool to /usr/local/bin
        run: |
          sudo cp /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/bin/libtool /usr/local/bin/libtool
          sudo chmod +x /usr/local/bin/libtool
          echo "/usr/local/bin:$PATH" >> $GITHUB_PATH
      - name: Check if R libtool supports -m
        run: |
          /usr/local/bin/libtool --help | grep -m 1 '\-m' || echo "libtool -m not supported"
      - name: Create /opt/R/arm64 symlinks
        run: |
          sudo mkdir -p /opt/R/arm64
          sudo ln -sf /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/include /opt/R/arm64/include
          sudo ln -sf /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib /opt/R/arm64/lib

      - name: Check R version
        run: |
          "/Library/Frameworks/R.framework/Resources/bin/R" --version

      - name: Install dependencies
        run: |
          "/Library/Frameworks/R.framework/Resources/bin/Rscript" -e 'install.packages(c("devtools", "tinytest"), repos="https://cloud.r-project.org")'

      - name: Install package
        run: |
          "/Library/Frameworks/R.framework/Resources/bin/R" CMD BUILD --preclean .
          "/Library/Frameworks/R.framework/Resources/bin/R" CMD INSTALL Rtinycc_*.tar.gz
      - name: Run tests
        run: |
          "/Library/Frameworks/R.framework/Resources/bin/Rscript" -e 'tinytest::test_package("Rtinycc")'
